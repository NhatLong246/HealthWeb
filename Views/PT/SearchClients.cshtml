@model HealthWeb.Services.SearchClientsViewModel
@{
    ViewData["Title"] = "Tìm Kiếm Khách Hàng - HealthWeb";
    Layout = "_Layout";
    
    var model = Model ?? new HealthWeb.Services.SearchClientsViewModel();
}

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="~/css/pt/pt-common.css">
<link rel="stylesheet" href="~/css/pt/searchClientsPT.css">

<div class="search-clients-container">
    <div class="search-header">
        <h1><i class="fas fa-search"></i> Tìm Kiếm Khách Hàng Tiềm Năng</h1>
        <p>Khám phá và kết nối với những khách hàng phù hợp với chuyên môn của bạn</p>
    </div>

    <!-- Search Section -->
    <form method="get" action="/PT/SearchClients" class="search-section">
        <div class="search-bar">
            <div class="search-input-wrapper">
                <i class="fas fa-search"></i>
                <input type="text" class="search-input" name="search" id="searchInput" placeholder="Tìm kiếm theo tên, username, mục tiêu..." value="@(model.Search ?? "")">
            </div>
            <button type="submit" class="search-btn">
                <i class="fas fa-search"></i> Tìm kiếm
            </button>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label><i class="fas fa-filter"></i> Mục tiêu</label>
                <select name="goal" id="goalFilter">
                    <option value="">Tất cả</option>
                    <option value="weight-loss" selected="@(model.Goal == "weight-loss")">Giảm cân</option>
                    <option value="muscle-gain" selected="@(model.Goal == "muscle-gain")">Tăng cơ</option>
                    <option value="cardio" selected="@(model.Goal == "cardio")">Cardio</option>
                    <option value="flexibility" selected="@(model.Goal == "flexibility")">Dẻo dai</option>
                    <option value="rehabilitation" selected="@(model.Goal == "rehabilitation")">Phục hồi</option>
                </select>
            </div>

            <div class="filter-group">
                <label><i class="fas fa-map-marker-alt"></i> Khu vực</label>
                <select name="location" id="locationFilter">
                    <option value="">Tất cả</option>
                    <option value="hanoi" selected="@(model.Location == "hanoi")">Hà Nội</option>
                    <option value="hcm" selected="@(model.Location == "hcm")">TP.HCM</option>
                    <option value="danang" selected="@(model.Location == "danang")">Đà Nẵng</option>
                    <option value="online" selected="@(model.Location == "online")">Online</option>
                </select>
            </div>

            <div class="filter-group">
                <label><i class="fas fa-clock"></i> Khung giờ</label>
                <select name="time" id="timeFilter">
                    <option value="">Tất cả</option>
                    <option value="morning" selected="@(model.Time == "morning")">Sáng (6h-12h)</option>
                    <option value="afternoon" selected="@(model.Time == "afternoon")">Chiều (12h-18h)</option>
                    <option value="evening" selected="@(model.Time == "evening")">Tối (18h-22h)</option>
                </select>
            </div>

            <div class="filter-group">
                <label><i class="fas fa-dollar-sign"></i> Ngân sách</label>
                <select name="budget" id="budgetFilter">
                    <option value="">Tất cả</option>
                    <option value="low" selected="@(model.Budget == "low")">Dưới 500k/buổi</option>
                    <option value="medium" selected="@(model.Budget == "medium")">500k-1tr/buổi</option>
                    <option value="high" selected="@(model.Budget == "high")">Trên 1tr/buổi</option>
                </select>
            </div>
        </div>
    </form>

    <!-- Results -->
    <div class="results-header">
        <div class="results-count">Tìm thấy <span id="resultNumber">@(model.Clients?.Count ?? 0)</span> khách hàng</div>
    </div>

    <!-- Clients Grid -->
    <div class="clients-grid" id="clientsGrid">
        @if (model.Clients != null && model.Clients.Any())
        {
            @foreach (var client in model.Clients)
            {
                <div class="client-card">
                    <div class="client-header">
                        <div class="client-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="client-info">
                            <h3>@client.Name</h3>
                            <p>@@@client.Username @if (!string.IsNullOrEmpty(client.Location)) { <text>• @client.Location</text> }</p>
                        </div>
                    </div>

                    <div class="client-tags">
                        @if (client.Tags != null && client.Tags.Any())
                        {
                            @foreach (var tag in client.Tags)
                            {
                                <span class="tag">@tag</span>
                            }
                        }
                        else
                        {
                            <span class="tag">Chưa cập nhật</span>
                        }
                    </div>

                    <div class="client-stats">
                        <div class="stat-item">
                            <div class="stat-value">@client.Stats.Sessions</div>
                            <div class="stat-label">Buổi tập</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">@client.Stats.Hours</div>
                            <div class="stat-label">Tổng giờ</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">@client.Stats.Rating.ToString("F1")</div>
                            <div class="stat-label">Đánh giá</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">@(client.Goal ?? "Chưa cập nhật")</div>
                            <div class="stat-label">Mục tiêu</div>
                        </div>
                    </div>

                    <div class="client-actions">
                        <button class="action-btn btn-primary" onclick="contactClient('@client.Id')">
                            <i class="fas fa-envelope"></i> Liên hệ
                        </button>
                        <button class="action-btn btn-secondary" onclick="viewProfile('@client.Id')">
                            <i class="fas fa-user-circle"></i> Xem profile
                        </button>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="empty-results" style="grid-column: 1 / -1;">
                <i class="fas fa-users"></i>
                <p>Không tìm thấy khách hàng nào phù hợp</p>
            </div>
        }
    </div>

    <div class="client-profile-modal" id="clientProfileModal" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="client-profile-card" role="document">
            <button type="button" class="client-profile-close" id="closeClientProfile" aria-label="Đóng bảng thông tin">
                <i class="fas fa-times"></i>
            </button>
            <div id="clientProfileContent"></div>
        </div>
    </div>
</div>

<script src="~/js/pt/searchClientsPT.js"></script>
<script>
    // Client-side functions for modal interactions only
    function contactClient(clientId) {
        console.log('Contact client:', clientId);
        alert('Tính năng đang phát triển!');
    }

    function viewProfile(clientId) {
        // Find client data from rendered HTML
        const clientCard = document.querySelector(`[onclick*="'${clientId}'"]`)?.closest('.client-card');
        if (!clientCard) return;
        
        const name = clientCard.querySelector('h3')?.textContent || '';
        const username = clientCard.querySelector('p')?.textContent || '';
        const location = clientCard.querySelector('.client-info p')?.textContent?.split('•')[1]?.trim() || 'Chưa cập nhật';
        const goal = clientCard.querySelector('.stat-item:last-child .stat-value')?.textContent || 'Chưa cập nhật';
        const sessions = clientCard.querySelector('.stat-item:first-child .stat-value')?.textContent || '0';
        const hours = clientCard.querySelector('.stat-item:nth-child(2) .stat-value')?.textContent || '0';
        const rating = clientCard.querySelector('.stat-item:nth-child(3) .stat-value')?.textContent || '0.0';
        
        const tags = Array.from(clientCard.querySelectorAll('.tag')).map(t => t.textContent);
        
        const modal = document.getElementById('clientProfileModal');
        const content = document.getElementById('clientProfileContent');
        
        if (!modal || !content) return;
        
        content.innerHTML = `
            <div class="client-profile-header">
                <div class="client-profile-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="client-profile-info">
                    <h3>${escapeHtml(name)}</h3>
                    <p><i class="fas fa-at"></i> ${escapeHtml(username)}</p>
                    <p><i class="fas fa-map-marker-alt"></i> ${escapeHtml(location)}</p>
                    <p><i class="fas fa-bullseye"></i> Mục tiêu chính: ${escapeHtml(goal)}</p>
                </div>
            </div>

            <div class="client-profile-section">
                <h4><i class="fas fa-chart-line"></i> Thống kê tập luyện</h4>
                <div class="client-profile-stats">
                    <div class="client-profile-stat">
                        <div class="value">${sessions}</div>
                        <div class="label">Tổng buổi tập</div>
                    </div>
                    <div class="client-profile-stat">
                        <div class="value">${hours}h</div>
                        <div class="label">Tổng giờ tập</div>
                    </div>
                    <div class="client-profile-stat">
                        <div class="value">${rating}</div>
                        <div class="label">Đánh giá trung bình</div>
                    </div>
                </div>
            </div>

            <div class="client-profile-section">
                <h4><i class="fas fa-tags"></i> Sở thích & nhu cầu</h4>
                <div class="client-profile-tags">
                    ${tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('') || '<span class="tag">Chưa cập nhật</span>'}
                </div>
            </div>

            <div class="client-actions" style="margin-top: 1.5rem;">
                <button class="action-btn btn-primary" onclick="contactClient('${clientId}')">
                    <i class="fas fa-paper-plane"></i> Liên hệ ngay
                </button>
                <button class="action-btn btn-secondary" onclick="closeClientProfile()">
                    <i class="fas fa-times-circle"></i> Đóng lại
                </button>
            </div>
        `;
        
        modal.classList.add('show');
        modal.setAttribute('aria-hidden', 'false');
    }

    function closeClientProfile() {
        const modal = document.getElementById('clientProfileModal');
        if (modal) {
            modal.classList.remove('show');
            modal.setAttribute('aria-hidden', 'true');
        }
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Auto-submit form on filter change
    document.addEventListener('DOMContentLoaded', function() {
        ['goalFilter', 'locationFilter', 'timeFilter', 'budgetFilter'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', function() {
                    this.closest('form')?.submit();
                });
            }
        });
    });
</script>

