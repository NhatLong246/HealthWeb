<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - HealthWeb</title>

    <link rel="icon" type="image/svg+xml" href='data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"%3E%3Cpath fill="%234ade80" d="M12 21s-6.716-4.29-9.338-7.62C.86 11.17 1.21 7.74 3.76 6.23c2.03-1.2 4.47-.56 6.02 1.03L12 9.5l2.22-2.24c1.55-1.59 3.99-2.23 6.02-1.03 2.55 1.51 2.9 4.94 1.1 7.15C18.72 16.71 12 21 12 21z"/%3E%3C/svg%3E'>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="~/css/common/toast.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/common/dialog.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/home.css?v=@DateTime.Now.Ticks" asp-append-version="true" />
    @await RenderSectionAsync("Styles", required: false)
    <style>
        /* Light Mode - Orange Pink Theme (With Grid Pattern) */
        body.light-mode {
            background: #fff5f5 !important;
            color: #7c2d12 !important;
            background-image: 
                linear-gradient(rgba(251, 146, 60, 0.6) 1px, transparent 1px),
                linear-gradient(90deg, rgba(251, 146, 60, 0.6) 1px, transparent 1px) !important;
            background-size: 30px 30px !important;
            animation: gridMove 15s linear infinite !important;
        }
        
        /* Dark Mode - Original Blue Theme (With Grid Pattern) */
        body.dark-mode {
            background: #1e293b !important;
            color: #ffffff !important;
            background-image: 
                linear-gradient(rgba(78, 222, 128, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(78, 222, 128, 0.1) 1px, transparent 1px) !important;
            background-size: 30px 30px !important;
            animation: gridMove 15s linear infinite !important;
        }

        @@keyframes gridMove {
            0% { background-position: 0 0; }
            100% { background-position: 30px 30px; }
        }
    </style>
</head>
<body class="dark-mode">
    <!-- Background Pattern -->
    <div class="background-pattern"></div>
    
    <!-- Header -->
    <header class="header">
        <div class="logo-container">
            <div class="logo">
                <i class="fas fa-heart-pulse"></i>
                <span>HealthWeb</span>
            </div>
            
            <!-- Home button for non-home pages -->
            @{
                var controller = ViewContext.RouteData.Values["controller"]?.ToString() ?? "";
                var action = ViewContext.RouteData.Values["action"]?.ToString() ?? "";
                var path = Context.Request.Path.Value ?? "";
                
                // Kiểm tra xem có phải trang PT không (bằng controller hoặc URL path)
                var isPTController = string.Equals(controller, "PT", StringComparison.OrdinalIgnoreCase);
                var isPTPath = path.StartsWith("/PT/", StringComparison.OrdinalIgnoreCase);
                var isPTPage = isPTController || isPTPath;
                
                // Kiểm tra xem có phải dashboard PT không
                var isPTDashboard = (isPTController && (string.Equals(action, "Dashboard", StringComparison.OrdinalIgnoreCase) || 
                                                         string.Equals(action, "DashboardPT", StringComparison.OrdinalIgnoreCase))) ||
                                    path.Equals("/PT/DashboardPT", StringComparison.OrdinalIgnoreCase) ||
                                    path.Equals("/PT/Dashboard", StringComparison.OrdinalIgnoreCase) ||
                                    path.Equals("/PT/Dashboard/", StringComparison.OrdinalIgnoreCase);
            }
            
            @if (isPTPage && !isPTDashboard)
            {
                <!-- Dashboard PT button for PT pages (except dashboard) -->
                <a href="/PT/DashboardPT" class="home-btn" title="Về Dashboard PT" style="display: flex !important;">
                    <i class="fas fa-home"></i>
                </a>
            }
            else if (!string.Equals(controller, "Home", StringComparison.OrdinalIgnoreCase) || 
                     !string.Equals(action, "Index", StringComparison.OrdinalIgnoreCase))
            {
                <!-- Home button for other non-home pages -->
                <a href="/" class="home-btn" title="Về trang chủ" style="display: flex !important;">
                    <i class="fas fa-home"></i>
                </a>
            }
        </div>
        
        <nav class="nav-links">
            <a href="/" class="requires-auth">Sức khỏe chung</a>
            <a href="/Ranking" class="requires-auth">Bảng xếp hạng</a>
            <a href="/DinhDuong" class="requires-auth">Dinh dưỡng</a>
            <a href="/MucTieu" class="requires-auth">Mục tiêu</a>
            <a href="/KeHoachTapLuyen" class="requires-auth">Kế hoạch</a>
            <a href="/ThongKe" class="requires-auth">Thống kê</a>
        </nav>
        
        <div class="header-actions">
            <i class="fas fa-bell requires-auth" id="notifBtn"></i>
            <i class="fas fa-robot requires-auth" id="chatBtn" title="Trợ lý AI"></i>
            <i class="fas fa-search"></i>
            <i class="fas fa-moon" id="theme-toggle"></i>
            <a href="/Account/Login" id="loginBtn" class="btn btn-secondary">Đăng nhập</a>
            <a href="/Account/Register" id="registerBtn" class="btn btn-primary">Đăng ký</a>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        @RenderBody()
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3>Về HealthWeb</h3>
                <p>Cùng bạn xây dựng lối sống khỏe mạnh mỗi ngày: luyện tập, dinh dưỡng và nghỉ ngơi khoa học.</p>
            </div>
            <div class="footer-section">
                <h3>Liên kết</h3>
                <a asp-area="" asp-controller="Home" asp-action="Privacy">Privacy</a>
                <a href="#">Điều khoản</a>
                <a href="#">Liên hệ</a>
                <a href="#">Trợ giúp</a>
            </div>
            <div class="footer-section">
                <h3>Chuyên mục</h3>
                <a href="#">Dinh dưỡng</a>
                <a href="#">Luyện tập</a>
                <a href="#">Giấc ngủ</a>
                <a href="#">Thói quen sống</a>
            </div>
            <div class="footer-section">
                <h3>Hỗ trợ</h3>
                <a href="#">Câu hỏi thường gặp</a>
                <a href="#">Hỗ trợ kỹ thuật</a>
                <a href="#">Góp ý</a>
                <a href="#">Báo lỗi</a>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 HealthWeb</p>
        </div>
    </footer>

    <script src="~/js/common/toast.js" asp-append-version="true"></script>
    <script src="~/js/common/dialog.js" asp-append-version="true"></script>
    <script src="~/js/home.js" asp-append-version="true"></script>
    <!-- Notification Drawer -->
    <div class="drawer-overlay" id="notifOverlay" style="display:none;"></div>
    <aside class="drawer" id="notifDrawer" aria-hidden="true">
        <div class="drawer-header">
            <div class="drawer-title"><i class="fas fa-bell"></i> Thông báo</div>
            <button class="drawer-close" id="notifClose" aria-label="Đóng"><i class="fas fa-xmark"></i></button>
        </div>
        <div class="drawer-user" id="notifUser">
            <div class="avatar"><i class="fas fa-user"></i></div>
            <div class="user-meta">
                <div class="name">Khách</div>
                <div class="note">Đăng nhập để xem thông báo cá nhân</div>
            </div>
        </div>
        <div class="drawer-body">
            <ul class="notif-list" id="notifList">
                <li class="muted">Đang tải...</li>
            </ul>
        </div>
    </aside>

    <!-- AI Chat Panel -->
    <div class="chat-overlay" id="chatOverlay" style="display:none;"></div>
    <aside class="chat-panel" id="chatPanel" aria-hidden="true">
        <div class="chat-header">
            <div class="chat-title">
                <i class="fas fa-robot"></i>
                <span>Trợ lý AI</span>
            </div>
            <button class="chat-close" id="chatClose" aria-label="Đóng"><i class="fas fa-xmark"></i></button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="chat-message bot-message">
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    <p>Xin chào! Tôi là trợ lý AI của HealthWeb. Tôi có thể giúp bạn về:</p>
                    <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
                        <li>Dinh dưỡng và chế độ ăn uống</li>
                        <li>Luyện tập và thể dục</li>
                        <li>Sức khỏe tổng quát</li>
                        <li>Mục tiêu sức khỏe</li>
                    </ul>
                    <p style="margin-top: 0.5rem;">Bạn muốn hỏi gì hôm nay?</p>
                </div>
            </div>
        </div>
        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <input type="text" id="chatInput" class="chat-input" placeholder="Nhập câu hỏi của bạn..." autocomplete="off">
                <button id="chatSend" class="chat-send-btn" title="Gửi">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <div class="chat-loading" id="chatLoading" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i>
                <span>AI đang suy nghĩ...</span>
            </div>
        </div>
    </aside>
    <script>
        // Manual theme toggle only
        function toggleTheme() {
            const body = document.body;
            
            if (body.classList.contains('light-mode')) {
                applyTheme('dark');
            } else {
                applyTheme('light');
            }
        }
        
        // Initialize theme
        function initTheme() {
            const body = document.body;
            const themeToggle = document.getElementById('theme-toggle');
            
            // Ưu tiên 1: Theme từ server (ViewData["UserTheme"] - đã được HomeController xử lý từ TempData hoặc database)
            @if (ViewData["UserTheme"] != null)
            {
                <text>
                const serverTheme = '@ViewData["UserTheme"]';
                console.log('Applying theme from server:', serverTheme);
                applyTheme(serverTheme);
                localStorage.setItem('theme', serverTheme);
                return;
                </text>
            }
            
            // Ưu tiên 2: localStorage
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                console.log('Applying theme from localStorage:', savedTheme);
                applyTheme(savedTheme);
            } else {
                // Default to dark mode
                console.log('Applying default dark theme');
                applyTheme('dark');
            }
        }
        
        function applyTheme(theme) {
            const body = document.body;
            const themeToggle = document.getElementById('theme-toggle');
            
            console.log('applyTheme called with:', theme);
            
            if (theme === 'Light' || theme === 'light') {
                body.classList.remove('dark-mode');
                body.classList.add('light-mode');
                if (themeToggle) themeToggle.className = 'fas fa-sun';
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.remove('light-mode');
                body.classList.add('dark-mode');
                if (themeToggle) themeToggle.className = 'fas fa-moon';
                localStorage.setItem('theme', 'dark');
            }
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            initTheme();
            
            // Theme toggle button
            document.getElementById('theme-toggle').addEventListener('click', function() {
                toggleTheme();
            });

            // Kiểm tra xác thực dựa trên session server
            async function fetchAuthStatus(){
                try {
                    const res = await fetch('/Account/IsAuthenticated', { credentials: 'same-origin' });
                    if(!res.ok) return { isAuthenticated: false };
                    return await res.json();
                } catch { return { isAuthenticated: false }; }
            }
            document.querySelectorAll('.requires-auth').forEach(el => {
                el.addEventListener('click', async function(e){
                    const status = await fetchAuthStatus();
                    if (!status?.isAuthenticated) {
                        e.preventDefault();
                        // lightweight inline notification
                        const n = document.createElement('div');
                        n.textContent = 'Vui lòng đăng nhập để sử dụng tính năng này.';
                        n.style.cssText = 'position:fixed;top:20px;right:20px;background:#ef4444;color:#fff;padding:12px 16px;border-radius:10px;z-index:10000;box-shadow:0 10px 30px rgba(0,0,0,.3)';
                        document.body.appendChild(n);
                        setTimeout(()=>{ n.remove(); }, 2500);
                        return;
                    }
                    // open drawer if bell or elements open it explicitly
                    if (this.id === 'notifBtn') {
                        e.preventDefault();
                        openDrawer();
                        loadNotifications();
                    }
                });
            });

            // Swap auth buttons -> user menu when logged in (client-side)
            const loginBtn = document.getElementById('loginBtn');
            const registerBtn = document.getElementById('registerBtn');
            async function renderUserMenu(){
                const actions = loginBtn?.parentElement;
                if(!actions) return;
                const status = await fetchAuthStatus();
                if(status?.isAuthenticated){
                    if(loginBtn) loginBtn.style.display='none';
                    if(registerBtn) registerBtn.style.display='none';
                    if(!document.getElementById('userMenuContainer')){
                        const username = status.username || 'User';
                        const container = document.createElement('div');
                        container.id = 'userMenuContainer';
                        container.className = 'user-menu-container';
                        container.innerHTML = `
                            <button class="user-menu-btn" id="userMenuBtn" title="Tài khoản">
                                <i class="fas fa-user"></i>
                                <span>${username}</span>
                                <i class="fas fa-chevron-down" id="chevronIcon"></i>
                            </button>
                            <div class="user-dropdown" id="userDropdown">
                                <a href="/Profile/Edit" class="dropdown-item">
                                    <i class="fas fa-user-edit"></i>
                                    <span>Thông tin cá nhân</span>
                                </a>
                                <a href="/Settings" class="dropdown-item">
                                    <i class="fas fa-cog"></i>
                                    <span>Cài đặt</span>
                                </a>
                                <a href="/FindPT" class="dropdown-item">
                                    <i class="fas fa-search"></i>
                                    <span>Tìm kiếm PT</span>
                                </a>
                                <a href="/Rating" class="dropdown-item">
                                    <i class="fas fa-star"></i>
                                    <span>Đánh giá buổi tập</span>
                                </a>
                                <a href="/PT/SwitchToPT" class="dropdown-item pt-mode-item">
                                    <i class="fas fa-dumbbell"></i>
                                    <span>Chế độ PT</span>
                                </a>
                                <a href="/Payment/MyPayments" class="dropdown-item payment-item">
                                    <i class="fas fa-credit-card"></i>
                                    <span>Thanh toán PT</span>
                                </a>
                                <div class="dropdown-divider"></div>
                                <a href="/Account/LogoutGet" class="dropdown-item">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span>Đăng xuất</span>
                                </a>
                            </div>
                        `;
                        actions.appendChild(container);
                        
                        // Toggle dropdown
                        const userMenuBtn = document.getElementById('userMenuBtn');
                        const userDropdown = document.getElementById('userDropdown');
                        const chevronIcon = document.getElementById('chevronIcon');
                        userMenuBtn?.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const isOpen = userDropdown?.classList.contains('show');
                            if (isOpen) {
                                userDropdown?.classList.remove('show');
                                chevronIcon?.style.setProperty('transform', 'rotate(0deg)');
                            } else {
                                userDropdown?.classList.add('show');
                                chevronIcon?.style.setProperty('transform', 'rotate(180deg)');
                            }
                        });
                        
                        // Close dropdown when clicking outside
                        document.addEventListener('click', function(e) {
                            if (!container.contains(e.target)) {
                                userDropdown?.classList.remove('show');
                                chevronIcon?.style.setProperty('transform', 'rotate(0deg)');
                            }
                        });
                    }
                } else {
                    if(loginBtn) loginBtn.style.display='inline-flex';
                    if(registerBtn) registerBtn.style.display='inline-flex';
                    const existing = document.getElementById('userMenuContainer');
                    if(existing) existing.remove();
                }
            }
            renderUserMenu();

            const overlay = document.getElementById('notifOverlay');
            const drawer = document.getElementById('notifDrawer');
            const closeBtn = document.getElementById('notifClose');

            function openDrawer(){ drawer.classList.add('open'); overlay.classList.add('open'); overlay.style.display='block'; }
            function closeDrawer(){ drawer.classList.remove('open'); overlay.classList.remove('open'); setTimeout(()=>{ overlay.style.display='none'; }, 250); }
            overlay?.addEventListener('click', closeDrawer);
            closeBtn?.addEventListener('click', closeDrawer);

            async function loadNotifications(){
                const list = document.getElementById('notifList');
                if(!list) return;
                list.innerHTML = '<li class="muted">Đang tải...</li>';
                try {
                    const res = await fetch('/Notifications/List');
                    if(!res.ok) throw new Error('Fetch failed');
                    const data = await res.json();
                    if(!Array.isArray(data) || data.length===0){ list.innerHTML = '<li class="muted">Chưa có thông báo.</li>'; return; }
                    list.innerHTML = data.map(n=>`
                        <li>
                            <div class="icon"><i class="fas ${n.icon || 'fa-bell'}"></i></div>
                            <div class="content">
                                <div>${n.title}</div>
                                <div class="time">${n.time || ''}</div>
                            </div>
                        </li>
                    `).join('');
                } catch {
                    list.innerHTML = '<li class="muted">Không thể tải thông báo.</li>';
                }
            }

            // AI Chat Panel
            const chatBtn = document.getElementById('chatBtn');
            const chatOverlay = document.getElementById('chatOverlay');
            const chatPanel = document.getElementById('chatPanel');
            const chatClose = document.getElementById('chatClose');
            const chatInput = document.getElementById('chatInput');
            const chatSend = document.getElementById('chatSend');
            const chatMessages = document.getElementById('chatMessages');
            const chatLoading = document.getElementById('chatLoading');

            async function openChatPanel() {
                // Kiểm tra authentication trước khi mở chat
                const status = await fetchAuthStatus();
                if (!status?.isAuthenticated) {
                    const n = document.createElement('div');
                    n.textContent = 'Vui lòng đăng nhập để sử dụng trợ lý AI.';
                    n.style.cssText = 'position:fixed;top:20px;right:20px;background:#ef4444;color:#fff;padding:12px 16px;border-radius:10px;z-index:10000;box-shadow:0 10px 30px rgba(0,0,0,.3)';
                    document.body.appendChild(n);
                    setTimeout(()=>{ n.remove(); }, 2500);
                    return;
                }
                
                chatPanel.classList.add('open');
                chatOverlay.classList.add('open');
                chatOverlay.style.display = 'block';
                chatInput.focus();
            }

            function closeChatPanel() {
                chatPanel.classList.remove('open');
                chatOverlay.classList.remove('open');
                setTimeout(() => {
                    chatOverlay.style.display = 'none';
                }, 250);
            }

            chatBtn?.addEventListener('click', async function(e) {
                e.preventDefault();
                await openChatPanel();
            });
            chatClose?.addEventListener('click', closeChatPanel);
            chatOverlay?.addEventListener('click', closeChatPanel);

            function addMessage(content, isUser = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${isUser ? 'user-message' : 'bot-message'}`;
                messageDiv.innerHTML = `
                    <div class="message-avatar">
                        <i class="fas ${isUser ? 'fa-user' : 'fa-robot'}"></i>
                    </div>
                    <div class="message-content">
                        ${content}
                    </div>
                `;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function formatMessage(text) {
                // Convert markdown-like formatting to HTML
                text = escapeHtml(text);
                // Convert newlines to <br>
                text = text.replace(/\n/g, '<br>');
                // Convert **bold** to <strong>
                text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                // Convert *italic* to <em>
                text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
                // Convert numbered lists
                text = text.replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>');
                // Wrap consecutive <li> in <ol>
                text = text.replace(/(<li>.*?<\/li>\n?)+/g, '<ol>$&</ol>');
                // Convert bullet points
                text = text.replace(/^[-•]\s+(.+)$/gm, '<li>$1</li>');
                // Wrap consecutive <li> in <ul>
                text = text.replace(/(<li>.*?<\/li>\n?)+/g, '<ul>$&</ul>');
                return `<p>${text}</p>`;
            }

            async function sendMessage() {
                const message = chatInput.value.trim();
                if (!message) return;

                // Add user message
                addMessage(`<p>${escapeHtml(message)}</p>`, true);
                chatInput.value = '';
                chatSend.disabled = true;
                chatLoading.style.display = 'flex';

                try {
                    const response = await fetch('/Chat/SendMessage', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message: message })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to get response');
                    }

                    const data = await response.json();
                    chatLoading.style.display = 'none';
                    chatSend.disabled = false;

                    if (data.success && data.response) {
                        addMessage(formatMessage(data.response), false);
                    } else {
                        addMessage('<p>Xin lỗi, đã xảy ra lỗi. Vui lòng thử lại.</p>', false);
                    }
                } catch (error) {
                    console.error('Chat error:', error);
                    chatLoading.style.display = 'none';
                    chatSend.disabled = false;
                    addMessage('<p>Không thể kết nối đến server. Vui lòng kiểm tra kết nối và thử lại.</p>', false);
                }
            }

            chatSend?.addEventListener('click', sendMessage);
            chatInput?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });
    </script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
