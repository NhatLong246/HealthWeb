@{
    ViewData["Title"] = "Dinh dưỡng - HealthWeb";
    var selectedDate = ViewData["SelectedDate"] as DateTime? ?? DateTime.Today;
    var nhatKyDinhDuong = ViewData["NhatKyDinhDuong"] as List<HealthWeb.Models.Entities.NhatKyDinhDuong> ?? new List<HealthWeb.Models.Entities.NhatKyDinhDuong>();
    var tongCalo = ViewData["TongCalo"] as double? ?? 0;
    var tongProtein = ViewData["TongProtein"] as double? ?? 0;
    var tongCarbs = ViewData["TongCarbs"] as double? ?? 0;
    var tongChatBeo = ViewData["TongChatBeo"] as double? ?? 0;
    var keHoachAnUong = ViewData["KeHoachAnUong"] as HealthWeb.Models.Entities.KeHoachAnUong;
    var monAnPhoBien = ViewData["MonAnPhoBien"] as List<HealthWeb.Models.Entities.DinhDuongMonAn> ?? new List<HealthWeb.Models.Entities.DinhDuongMonAn>();
}

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<style>
    .nutrition-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
        padding-top: calc(70px + 2rem);
    }

    .nutrition-header {
        text-align: center;
        margin-bottom: 3rem;
    }

    .nutrition-header h1 {
        font-size: 3rem;
        margin-bottom: 1rem;
        background: linear-gradient(135deg, #4ade80, #22d3ee);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .date-selector {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .date-selector button {
        background: transparent;
        border: 2px solid currentColor;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        color: inherit;
    }

    .date-selector button:hover {
        background: rgba(78, 222, 128, 0.2);
        border-color: #4ade80;
    }

    .date-selector input[type="date"] {
        padding: 0.8rem 1.5rem;
        border: 2px solid rgba(148, 163, 184, 0.3);
        border-radius: 12px;
        background: rgba(30, 41, 59, 0.8);
        color: #fff;
        font-size: 1rem;
        outline: none;
        transition: all 0.3s ease;
    }

    body.light-mode .date-selector input[type="date"] {
        background: #fff;
        color: #7c2d12;
        border-color: rgba(251, 146, 60, 0.3);
    }

    .date-selector input[type="date"]:focus {
        border-color: #4ade80;
        box-shadow: 0 0 20px rgba(78, 222, 128, 0.3);
    }

    .nutrition-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 3rem;
    }

    .summary-card {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 20px;
        padding: 1.5rem;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        text-align: center;
        transition: all 0.3s ease;
    }

    body.light-mode .summary-card {
        background: rgba(255, 255, 255, 0.7);
        border-color: rgba(251, 146, 60, 0.3);
    }

    .summary-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .summary-card .icon {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        background: linear-gradient(135deg, #4ade80, #22d3ee);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .summary-card .value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }

    .summary-card .label {
        font-size: 0.9rem;
        opacity: 0.8;
    }

    .nutrition-content {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
        margin-bottom: 3rem;
    }

    @@media (max-width: 968px) {
        .nutrition-content {
            grid-template-columns: 1fr;
        }
    }

    .meal-log {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 20px;
        padding: 2rem;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    body.light-mode .meal-log {
        background: rgba(255, 255, 255, 0.7);
        border-color: rgba(251, 146, 60, 0.3);
    }

    .meal-log-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .meal-log-header h3 {
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .add-meal-btn {
        padding: 0.8rem 1.5rem;
        background: linear-gradient(135deg, #4ade80, #22d3ee);
        border: none;
        border-radius: 12px;
        color: #fff;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .add-meal-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(78, 222, 128, 0.4);
    }

    .meal-item {
        background: rgba(255, 255, 255, 0.03);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
    }

    body.light-mode .meal-item {
        background: rgba(255, 255, 255, 0.5);
    }

    .meal-item:hover {
        background: rgba(255, 255, 255, 0.08);
        transform: translateX(5px);
    }

    .meal-info {
        flex: 1;
    }

    .meal-name {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .meal-details {
        display: flex;
        gap: 1rem;
        font-size: 0.9rem;
        opacity: 0.8;
    }

    .meal-actions {
        display: flex;
        gap: 0.5rem;
    }

    .meal-actions button {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        padding: 0.5rem;
        cursor: pointer;
        color: inherit;
        transition: all 0.3s ease;
    }

    .meal-actions button:hover {
        background: rgba(239, 68, 68, 0.2);
        border-color: #ef4444;
    }

    .popular-foods {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 20px;
        padding: 2rem;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    body.light-mode .popular-foods {
        background: rgba(255, 255, 255, 0.7);
        border-color: rgba(251, 146, 60, 0.3);
    }

    .popular-foods h3 {
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .food-item {
        background: rgba(255, 255, 255, 0.03);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    body.light-mode .food-item {
        background: rgba(255, 255, 255, 0.5);
    }

    .food-item:hover {
        background: rgba(255, 255, 255, 0.08);
        transform: translateX(5px);
    }

    .food-name {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .food-macros {
        font-size: 0.85rem;
        opacity: 0.7;
    }

    .meal-plan-card {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 20px;
        padding: 2rem;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 2rem;
    }

    body.light-mode .meal-plan-card {
        background: rgba(255, 255, 255, 0.7);
        border-color: rgba(251, 146, 60, 0.3);
    }

    .meal-plan-card h3 {
        font-size: 1.5rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        opacity: 0.6;
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
    }

    /* Modal for adding meal */
    .modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
        animation: fadeIn 0.3s ease;
    }

    .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @@keyframes slideUp {
        from {
            transform: translateY(50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-content {
        background: rgba(30, 41, 59, 0.98);
        padding: 0;
        border-radius: 20px;
        width: 90%;
        max-width: 700px;
        max-height: 85vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        animation: slideUp 0.3s ease;
    }

    body.light-mode .modal-content {
        background: rgba(255, 255, 255, 0.98);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem 2rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    body.light-mode .modal-header {
        border-bottom-color: rgba(251, 146, 60, 0.2);
    }

    .modal-header h2 {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
    }

    .close-modal {
        background: transparent;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: inherit;
        line-height: 1;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        transition: all 0.2s ease;
    }

    .close-modal:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .modal-body {
        padding: 1.5rem 2rem;
        overflow-y: auto;
        flex: 1;
    }

    .search-food {
        margin-bottom: 1.5rem;
    }

    .search-food input {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 2px solid rgba(148, 163, 184, 0.3);
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.05);
        color: #fff;
        font-size: 1rem;
        outline: none;
        transition: all 0.3s ease;
    }

    body.light-mode .search-food input {
        background: #fff;
        color: #7c2d12;
        border-color: rgba(251, 146, 60, 0.3);
    }

    .search-food input:focus {
        border-color: #4ade80;
        box-shadow: 0 0 0 3px rgba(78, 222, 128, 0.1);
    }

    .food-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .food-list-item {
        padding: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        cursor: pointer;
        transition: all 0.2s ease;
        border-radius: 8px;
        margin-bottom: 0.5rem;
    }

    body.light-mode .food-list-item {
        border-bottom-color: rgba(251, 146, 60, 0.2);
    }

    .food-list-item:hover {
        background: rgba(78, 222, 128, 0.1);
        transform: translateX(5px);
    }

    .food-list-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }

    .food-list-empty {
        text-align: center;
        padding: 3rem;
        opacity: 0.6;
    }

    /* Food Detail Form Dialog */
    .food-detail-dialog {
        display: none;
        position: fixed;
        z-index: 10001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
        animation: fadeIn 0.3s ease;
    }

    .food-detail-dialog.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .food-detail-content {
        background: rgba(30, 41, 59, 0.98);
        padding: 2rem;
        border-radius: 20px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        animation: slideUp 0.3s ease;
    }

    body.light-mode .food-detail-content {
        background: rgba(255, 255, 255, 0.98);
    }

    .food-detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .food-detail-header h3 {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        font-size: 0.9rem;
    }

    .form-group input {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 2px solid rgba(148, 163, 184, 0.3);
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.05);
        color: #fff;
        font-size: 1rem;
        outline: none;
        transition: all 0.3s ease;
    }

    .form-group select {
        width: 100%;
        padding: 0.875rem 1rem;
        padding-right: 2.5rem;
        border: 2px solid rgba(148, 163, 184, 0.3);
        border-radius: 12px;
        background-color: rgba(30, 41, 59, 0.8);
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23ffffff' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 1rem center;
        background-size: 12px;
        color: #fff;
        font-size: 1rem;
        outline: none;
        transition: all 0.3s ease;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        cursor: pointer;
    }

    body.light-mode .form-group input {
        background: #fff;
        color: #7c2d12;
        border-color: rgba(251, 146, 60, 0.3);
    }

    body.light-mode .form-group select {
        background-color: #fff;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%237c2d12' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 1rem center;
        background-size: 12px;
        color: #7c2d12;
        border-color: rgba(251, 146, 60, 0.3);
    }

    .form-group select option {
        background: rgba(30, 41, 59, 0.95);
        color: #fff;
        padding: 0.5rem;
    }

    body.light-mode .form-group select option {
        background: #fff;
        color: #7c2d12;
    }

    .form-group input:focus {
        border-color: #4ade80;
        box-shadow: 0 0 0 3px rgba(78, 222, 128, 0.1);
        background-color: rgba(255, 255, 255, 0.08);
    }

    .form-group select:focus {
        border-color: #4ade80;
        box-shadow: 0 0 0 3px rgba(78, 222, 128, 0.1);
        background-color: rgba(30, 41, 59, 0.95);
    }

    body.light-mode .form-group input:focus {
        background-color: #fff;
    }

    body.light-mode .form-group select:focus {
        background-color: #fff;
    }

    .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 2rem;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1rem;
    }

    .btn-primary {
        background: linear-gradient(135deg, #4ade80, #22d3ee);
        color: #fff;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(78, 222, 128, 0.4);
    }

    .btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        color: inherit;
    }

    body.light-mode .btn-secondary {
        background: rgba(251, 146, 60, 0.1);
    }

    .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .food-info-preview {
        background: rgba(78, 222, 128, 0.1);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        border: 1px solid rgba(78, 222, 128, 0.3);
    }

    body.light-mode .food-info-preview {
        background: rgba(251, 146, 60, 0.1);
        border-color: rgba(251, 146, 60, 0.3);
    }

    .food-info-preview .food-name {
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
    }

    .food-info-preview .food-macros {
        font-size: 0.9rem;
        opacity: 0.8;
    }

    /* Delete Confirmation Dialog */
    .delete-confirm-dialog {
        display: none;
        position: fixed;
        z-index: 10002;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
        animation: fadeIn 0.3s ease;
    }

    .delete-confirm-dialog.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .delete-confirm-content {
        background: rgba(30, 41, 59, 0.98);
        padding: 2rem;
        border-radius: 20px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        animation: slideUp 0.3s ease;
        text-align: center;
    }

    body.light-mode .delete-confirm-content {
        background: rgba(255, 255, 255, 0.98);
    }

    .delete-confirm-icon {
        font-size: 3rem;
        color: #ef4444;
        margin-bottom: 1rem;
    }

    .delete-confirm-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .delete-confirm-message {
        font-size: 0.95rem;
        opacity: 0.8;
        margin-bottom: 2rem;
    }

    .delete-confirm-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
    }

    .btn-danger {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: #fff;
    }

    .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(239, 68, 68, 0.4);
    }

    /* Stats Section */
    .stats-section {
        margin-top: 3rem;
        margin-bottom: 3rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .stat-card-large {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 20px;
        padding: 2rem;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        gap: 1.5rem;
        transition: all 0.3s ease;
    }

    body.light-mode .stat-card-large {
        background: rgba(255, 255, 255, 0.7);
        border-color: rgba(251, 146, 60, 0.3);
    }

    .stat-card-large:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .stat-icon {
        font-size: 3rem;
        background: linear-gradient(135deg, #4ade80, #22d3ee);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .stat-content {
        flex: 1;
    }

    .stat-label {
        font-size: 0.9rem;
        opacity: 0.8;
        margin-bottom: 0.5rem;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.25rem;
    }

    .stat-sub {
        font-size: 0.85rem;
        opacity: 0.7;
    }

    /* Chart Section */
    .chart-section {
        margin-top: 3rem;
        margin-bottom: 3rem;
    }

    .chart-container {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 20px;
        padding: 2rem;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    body.light-mode .chart-container {
        background: rgba(255, 255, 255, 0.7);
        border-color: rgba(251, 146, 60, 0.3);
    }

    .chart-bars {
        display: flex;
        justify-content: space-around;
        align-items: flex-end;
        gap: 1rem;
        min-height: 300px;
        padding: 1rem 0;
    }

    .chart-bar-item {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
    }

    .chart-bar {
        width: 100%;
        background: linear-gradient(180deg, #4ade80, #22d3ee);
        border-radius: 8px 8px 0 0;
        min-height: 20px;
        position: relative;
        transition: all 0.3s ease;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        padding-top: 0.5rem;
    }

    .chart-bar:hover {
        opacity: 0.8;
        transform: scaleY(1.05);
    }

    .chart-value {
        font-size: 0.75rem;
        font-weight: 600;
        color: #fff;
    }

    .chart-label {
        font-size: 0.85rem;
        opacity: 0.8;
        text-align: center;
    }

    /* Macro Section */
    .macro-section {
        margin-top: 3rem;
        margin-bottom: 3rem;
    }

    .macro-analysis {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 20px;
        padding: 2rem;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    body.light-mode .macro-analysis {
        background: rgba(255, 255, 255, 0.7);
        border-color: rgba(251, 146, 60, 0.3);
    }

    .macro-item {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .macro-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        font-size: 1rem;
    }

    .macro-bar {
        width: 100%;
        height: 30px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        overflow: hidden;
        position: relative;
    }

    body.light-mode .macro-bar {
        background: rgba(251, 146, 60, 0.1);
    }

    .macro-fill {
        height: 100%;
        border-radius: 15px;
        transition: width 0.5s ease;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: 0.5rem;
        color: #fff;
        font-weight: 600;
        font-size: 0.85rem;
    }

    .macro-value {
        font-size: 0.9rem;
        opacity: 0.8;
        text-align: right;
    }

    /* History Section */
    .history-section {
        margin-top: 3rem;
        margin-bottom: 3rem;
    }

    .history-list {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 20px;
        padding: 2rem;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        max-height: 600px;
        overflow-y: auto;
    }

    body.light-mode .history-list {
        background: rgba(255, 255, 255, 0.7);
        border-color: rgba(251, 146, 60, 0.3);
    }

    .history-date-header {
        font-size: 1.1rem;
        font-weight: 600;
        margin-top: 1.5rem;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid rgba(78, 222, 128, 0.3);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .history-date-header:first-child {
        margin-top: 0;
    }

    .history-item {
        padding: 1rem;
        margin-bottom: 0.75rem;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    body.light-mode .history-item {
        background: rgba(255, 255, 255, 0.5);
    }

    .history-item:hover {
        background: rgba(255, 255, 255, 0.08);
        transform: translateX(5px);
    }

    .history-meal-name {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .history-meal-details {
        font-size: 0.9rem;
        opacity: 0.8;
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    @@media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }

        .chart-bars {
            gap: 0.5rem;
        }

        .chart-value {
            font-size: 0.65rem;
        }
    }
</style>

<div class="nutrition-container">
    <div class="nutrition-header">
        <h1><i class="fas fa-apple-whole"></i> Dinh Dưỡng</h1>
        <p>Theo dõi và quản lý dinh dưỡng hàng ngày của bạn</p>
    </div>

    <!-- Date Selector -->
    <div class="date-selector">
        <button onclick="changeDate(-1)" title="Ngày trước">
            <i class="fas fa-chevron-left"></i>
        </button>
        <input type="date" id="selectedDate" value="@selectedDate.ToString("yyyy-MM-dd")" onchange="loadNutritionData()">
        <button onclick="changeDate(1)" title="Ngày sau">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>

    <!-- Nutrition Summary -->
    <div class="nutrition-summary">
        <div class="summary-card">
            <div class="icon"><i class="fas fa-fire"></i></div>
            <div class="value" id="totalCalo">@Math.Round(tongCalo, 0)</div>
            <div class="label">Calo (kcal)</div>
        </div>
        <div class="summary-card">
            <div class="icon"><i class="fas fa-dumbbell"></i></div>
            <div class="value" id="totalProtein">@Math.Round(tongProtein, 1)</div>
            <div class="label">Protein (g)</div>
        </div>
        <div class="summary-card">
            <div class="icon"><i class="fas fa-bread-slice"></i></div>
            <div class="value" id="totalCarbs">@Math.Round(tongCarbs, 1)</div>
            <div class="label">Carbs (g)</div>
        </div>
        <div class="summary-card">
            <div class="icon"><i class="fas fa-oil-can"></i></div>
            <div class="value" id="totalFat">@Math.Round(tongChatBeo, 1)</div>
            <div class="label">Chất béo (g)</div>
        </div>
    </div>

    <!-- Meal Plan Card -->
    @if (keHoachAnUong != null)
    {
        <div class="meal-plan-card">
            <h3><i class="fas fa-calendar-check"></i> Kế hoạch ăn uống</h3>
            <p><strong>@keHoachAnUong.TenKeHoach</strong></p>
            @if (!string.IsNullOrEmpty(keHoachAnUong.MoTa))
            {
                <p>@keHoachAnUong.MoTa</p>
            }
            @if (keHoachAnUong.LuongCaloMucTieu.HasValue)
            {
                <p>Mục tiêu: @keHoachAnUong.LuongCaloMucTieu kcal/ngày</p>
            }
        </div>
    }

    <!-- Main Content -->
    <div class="nutrition-content">
        <!-- Meal Log -->
        <div class="meal-log">
            <div class="meal-log-header">
                <h3><i class="fas fa-utensils"></i> Nhật ký bữa ăn</h3>
                <button class="add-meal-btn" onclick="openAddMealModal()">
                    <i class="fas fa-plus"></i> Thêm món
                </button>
            </div>
            <div id="mealList">
                @if (nhatKyDinhDuong.Any())
                {
                    @foreach (var item in nhatKyDinhDuong)
                    {
                        var monAn = item.MonAn;
                        var luong = item.LuongThucAn ?? 0;
                        var donViTinh = monAn?.DonViTinh?.ToLower()?.Trim() ?? "";
                        var isPieceOrBowl = donViTinh == "cái" || donViTinh == "chén";
                        var calo = isPieceOrBowl ? (monAn?.LuongCalo ?? 0) * luong : (monAn?.LuongCalo ?? 0) * luong / 100;
                        var protein = isPieceOrBowl ? (monAn?.Protein ?? 0) * luong : (monAn?.Protein ?? 0) * luong / 100;
                        var carbs = isPieceOrBowl ? (monAn?.Carbohydrate ?? 0) * luong : (monAn?.Carbohydrate ?? 0) * luong / 100;
                        var fat = isPieceOrBowl ? (monAn?.ChatBeo ?? 0) * luong : (monAn?.ChatBeo ?? 0) * luong / 100;
                        
                        <div class="meal-item" data-id="@item.DinhDuongId">
                            <div class="meal-info">
                                <div class="meal-name">@monAn?.TenMonAn</div>
                                <div class="meal-details">
                                    <span>@luong @monAn?.DonViTinh</span>
                                    <span>•</span>
                                    <span>@Math.Round(calo, 0) kcal</span>
                                    <span>•</span>
                                    <span>P: @Math.Round(protein, 1)g</span>
                                    <span>•</span>
                                    <span>C: @Math.Round(carbs, 1)g</span>
                                    <span>•</span>
                                    <span>F: @Math.Round(fat, 1)g</span>
                                </div>
                                @if (!string.IsNullOrEmpty(item.GhiChu))
                                {
                                    <div style="font-size: 0.85rem; opacity: 0.7; margin-top: 0.25rem;">
                                        <i class="fas fa-tag"></i> @item.GhiChu
                                    </div>
                                }
                            </div>
                            <div class="meal-actions">
                                <button onclick="removeMeal('@item.DinhDuongId')" title="Xóa">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="empty-state">
                        <i class="fas fa-utensils"></i>
                        <p>Chưa có món ăn nào được thêm vào hôm nay</p>
                    </div>
                }
            </div>
        </div>

        <!-- Popular Foods -->
        <div class="popular-foods">
            <h3><i class="fas fa-star"></i> Món ăn phổ biến</h3>
            <div id="popularFoodsList">
                @foreach (var monAn in monAnPhoBien.Take(10))
                {
                    <div class="food-item" onclick="addMealFromPopular('@monAn.MonAnId', '@monAn.TenMonAn')">
                        <div class="food-name">@monAn.TenMonAn</div>
                        <div class="food-macros">
                            @if (monAn.LuongCalo.HasValue)
                            {
                                <span>@Math.Round(monAn.LuongCalo.Value, 0) kcal</span>
                            }
                            @if (monAn.Protein.HasValue)
                            {
                                <span> • P: @Math.Round(monAn.Protein.Value, 1)g</span>
                            }
                            @if (monAn.Carbohydrate.HasValue)
                            {
                                <span> • C: @Math.Round(monAn.Carbohydrate.Value, 1)g</span>
                            }
                            @if (monAn.ChatBeo.HasValue)
                            {
                                <span> • F: @Math.Round(monAn.ChatBeo.Value, 1)g</span>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Weekly/Monthly Statistics -->
    @{
        var tongCaloTuan = ViewData["TongCaloTuan"] as double? ?? 0;
        var tongCaloThang = ViewData["TongCaloThang"] as double? ?? 0;
        var nhatKy7Ngay = ViewData["NhatKy7Ngay"] as dynamic;
        var lichSu7Ngay = ViewData["LichSu7Ngay"] as List<HealthWeb.Models.Entities.NhatKyDinhDuong> ?? new List<HealthWeb.Models.Entities.NhatKyDinhDuong>();
    }
    
    <div class="stats-section">
        <h3 style="font-size: 1.5rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-chart-line"></i> Thống kê dinh dưỡng
        </h3>
        <div class="stats-grid">
            <div class="stat-card-large">
                <div class="stat-icon"><i class="fas fa-calendar-week"></i></div>
                <div class="stat-content">
                    <div class="stat-label">Tuần này</div>
                    <div class="stat-value">@Math.Round(tongCaloTuan, 0) kcal</div>
                    <div class="stat-sub">Trung bình: @Math.Round(tongCaloTuan / 7, 0) kcal/ngày</div>
                </div>
            </div>
            <div class="stat-card-large">
                <div class="stat-icon"><i class="fas fa-calendar-alt"></i></div>
                <div class="stat-content">
                    <div class="stat-label">Tháng này</div>
                    <div class="stat-value">@Math.Round(tongCaloThang, 0) kcal</div>
                    <div class="stat-sub">Trung bình: @Math.Round(tongCaloThang / DateTime.DaysInMonth(DateTime.Now.Year, DateTime.Now.Month), 0) kcal/ngày</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Calo Chart 7 Days -->
    <div class="chart-section">
        <h3 style="font-size: 1.5rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-chart-bar"></i> Biểu đồ calo 7 ngày gần nhất
        </h3>
        <div class="chart-container">
            <div class="chart-bars">
                @{
                    var maxCalo = nhatKy7Ngay != null && ((IEnumerable<dynamic>)nhatKy7Ngay).Any() 
                        ? ((IEnumerable<dynamic>)nhatKy7Ngay).Max(x => (double?)x.TongCalo) ?? 2000 
                        : 2000;
                    var days = new[] { "CN", "T2", "T3", "T4", "T5", "T6", "T7" };
                    var dayIndex = 0;
                }
                @if (nhatKy7Ngay != null)
                {
                    @foreach (var item in (IEnumerable<dynamic>)nhatKy7Ngay)
                    {
                        var height = maxCalo > 0 ? ((double)item.TongCalo / maxCalo * 100) : 0;
                        <div class="chart-bar-item">
                            <div class="chart-bar" style="height: @(height)%">
                                <span class="chart-value">@Math.Round((double)item.TongCalo, 0)</span>
                            </div>
                            <div class="chart-label">@item.Ngay.ToString("dd/MM")</div>
                        </div>
                        dayIndex++;
                    }
                }
                @for (int i = dayIndex; i < 7; i++)
                {
                    <div class="chart-bar-item">
                        <div class="chart-bar" style="height: 0%">
                            <span class="chart-value">0</span>
                        </div>
                        <div class="chart-label">—</div>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Macro Analysis -->
    <div class="macro-section">
        <h3 style="font-size: 1.5rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-pie-chart"></i> Phân tích Macro
        </h3>
        <div class="macro-analysis">
            @{
                var totalMacro = tongProtein + tongCarbs + tongChatBeo;
                var proteinPercent = totalMacro > 0 ? (tongProtein / totalMacro * 100) : 0;
                var carbsPercent = totalMacro > 0 ? (tongCarbs / totalMacro * 100) : 0;
                var fatPercent = totalMacro > 0 ? (tongChatBeo / totalMacro * 100) : 0;
            }
            <div class="macro-item">
                <div class="macro-label">
                    <i class="fas fa-dumbbell" style="color: #4ade80;"></i>
                    <span>Protein</span>
                </div>
                <div class="macro-bar">
                    <div class="macro-fill" style="width: @(proteinPercent)%; background: linear-gradient(135deg, #4ade80, #22c55e);"></div>
                </div>
                <div class="macro-value">@Math.Round(tongProtein, 1)g (@Math.Round(proteinPercent, 1)%)</div>
            </div>
            <div class="macro-item">
                <div class="macro-label">
                    <i class="fas fa-bread-slice" style="color: #22d3ee;"></i>
                    <span>Carbs</span>
                </div>
                <div class="macro-bar">
                    <div class="macro-fill" style="width: @(carbsPercent)%; background: linear-gradient(135deg, #22d3ee, #06b6d4);"></div>
                </div>
                <div class="macro-value">@Math.Round(tongCarbs, 1)g (@Math.Round(carbsPercent, 1)%)</div>
            </div>
            <div class="macro-item">
                <div class="macro-label">
                    <i class="fas fa-oil-can" style="color: #fbbf24;"></i>
                    <span>Chất béo</span>
                </div>
                <div class="macro-bar">
                    <div class="macro-fill" style="width: @(fatPercent)%; background: linear-gradient(135deg, #fbbf24, #f59e0b);"></div>
                </div>
                <div class="macro-value">@Math.Round(tongChatBeo, 1)g (@Math.Round(fatPercent, 1)%)</div>
            </div>
        </div>
    </div>

    <!-- Meal History -->
    <div class="history-section">
        <h3 style="font-size: 1.5rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-history"></i> Lịch sử ăn uống 7 ngày gần nhất
        </h3>
        <div class="history-list">
            @if (lichSu7Ngay.Any())
            {
                var currentDate = DateOnly.MinValue;
                @foreach (var item in lichSu7Ngay)
                {
                    if (item.NgayGhiLog != currentDate)
                    {
                        currentDate = item.NgayGhiLog;
                        <div class="history-date-header">
                            <i class="fas fa-calendar-day"></i>
                            @currentDate.ToString("dd/MM/yyyy") - @{
                                var dayName = currentDate.DayOfWeek switch
                                {
                                    DayOfWeek.Monday => "Thứ Hai",
                                    DayOfWeek.Tuesday => "Thứ Ba",
                                    DayOfWeek.Wednesday => "Thứ Tư",
                                    DayOfWeek.Thursday => "Thứ Năm",
                                    DayOfWeek.Friday => "Thứ Sáu",
                                    DayOfWeek.Saturday => "Thứ Bảy",
                                    DayOfWeek.Sunday => "Chủ Nhật",
                                    _ => ""
                                };
                            }@dayName
                        </div>
                    }
                    var monAn = item.MonAn;
                    var luong = item.LuongThucAn ?? 0;
                    var donViTinh = monAn?.DonViTinh?.ToLower()?.Trim() ?? "";
                    var isPieceOrBowl = donViTinh == "cái" || donViTinh == "chén";
                    var calo = isPieceOrBowl ? (monAn?.LuongCalo ?? 0) * luong : (monAn?.LuongCalo ?? 0) * luong / 100;
                    <div class="history-item">
                        <div class="history-meal-name">@monAn?.TenMonAn</div>
                        <div class="history-meal-details">
                            <span>@luong @monAn?.DonViTinh</span>
                            <span>•</span>
                            <span>@Math.Round(calo, 0) kcal</span>
                            @if (!string.IsNullOrEmpty(item.GhiChu))
                            {
                                <span>•</span>
                                <span><i class="fas fa-tag"></i> @item.GhiChu</span>
                            }
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="empty-state">
                    <i class="fas fa-history"></i>
                    <p>Chưa có lịch sử ăn uống</p>
                </div>
            }
        </div>
    </div>
</div>

<!-- Add Meal Modal -->
<div id="addMealModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Thêm món ăn</h2>
            <button class="close-modal" onclick="closeAddMealModal()" title="Đóng">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="search-food">
                <input type="text" id="searchFoodInput" placeholder="Tìm kiếm món ăn..." autocomplete="off">
            </div>
            <div class="food-list" id="foodList">
                <div class="food-list-empty">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                    <p>Đang tải danh sách món ăn...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Food Detail Dialog -->
<div id="foodDetailDialog" class="food-detail-dialog">
    <div class="food-detail-content">
        <div class="food-detail-header">
            <h3>Thông tin món ăn</h3>
            <button class="close-modal" onclick="closeFoodDetailDialog()" title="Đóng">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="foodInfoPreview" class="food-info-preview">
            <!-- Food info will be displayed here -->
        </div>
        <form id="foodDetailForm" onsubmit="submitFoodDetail(event)">
            <div class="form-group">
                <label for="luongThucAn">Lượng thực phẩm</label>
                <input type="number" id="luongThucAn" name="luongThucAn" min="1" step="0.1" required placeholder="Nhập số lượng">
            </div>
            <div class="form-group">
                <label for="donViTinh">Đơn vị</label>
                <input type="text" id="donViTinh" name="donViTinh" readonly>
            </div>
            <div class="form-group">
                <label for="ghiChu">Bữa ăn</label>
                <select id="ghiChu" name="ghiChu">
                    <option value="Bữa Sáng">Bữa Sáng</option>
                    <option value="Bữa Trưa">Bữa Trưa</option>
                    <option value="Bữa Tối">Bữa Tối</option>
                    <option value="Bữa Phụ">Bữa Phụ</option>
                </select>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeFoodDetailDialog()">Hủy</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Thêm vào nhật ký
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Dialog -->
<div id="deleteConfirmDialog" class="delete-confirm-dialog">
    <div class="delete-confirm-content">
        <div class="delete-confirm-icon">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="delete-confirm-title">Xác nhận xóa</div>
        <div class="delete-confirm-message">
            Bạn có chắc chắn muốn xóa món ăn này khỏi nhật ký?
        </div>
        <div class="delete-confirm-actions">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteConfirmDialog()">
                <i class="fas fa-times"></i> Hủy
            </button>
            <button type="button" class="btn btn-danger" onclick="confirmDeleteMeal()">
                <i class="fas fa-trash"></i> Xóa
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let allFoods = [];

        function changeDate(days) {
            const dateInput = document.getElementById('selectedDate');
            const currentDate = new Date(dateInput.value);
            currentDate.setDate(currentDate.getDate() + days);
            dateInput.value = currentDate.toISOString().split('T')[0];
            loadNutritionData();
        }

        function loadNutritionData() {
            const date = document.getElementById('selectedDate').value;
            window.location.href = `/DinhDuong?selectedDate=${date}`;
        }

        let selectedFood = null;

        function openAddMealModal() {
            const modal = document.getElementById('addMealModal');
            modal.classList.add('show');
            
            // Setup search input listeners
            setupSearchInput();
            
            loadFoods();
            
            // Focus search input
            setTimeout(() => {
                const searchInput = document.getElementById('searchFoodInput');
                if (searchInput) {
                    searchInput.focus();
                }
            }, 100);
        }

        function closeAddMealModal() {
            const modal = document.getElementById('addMealModal');
            modal.classList.remove('show');
            document.getElementById('searchFoodInput').value = '';
            document.getElementById('foodList').innerHTML = '<div class="food-list-empty"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i><p>Đang tải danh sách món ăn...</p></div>';
        }

        async function loadFoods(search = '') {
            const foodList = document.getElementById('foodList');
            
            try {
                foodList.innerHTML = '<div class="food-list-empty"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i><p>Đang tải...</p></div>';
                
                const response = await fetch(`/DinhDuong/GetMonAn?search=${encodeURIComponent(search)}`);
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                
                const result = await response.json();
                
                if (result.success && result.data && Array.isArray(result.data)) {
                    allFoods = result.data;
                    displayFoods(allFoods);
                } else {
                    throw new Error('Invalid response format');
                }
            } catch (error) {
                console.error('Error loading foods:', error);
                foodList.innerHTML = '<div class="food-list-empty"><i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i><p>Không thể tải danh sách món ăn. Vui lòng thử lại.</p></div>';
            }
        }

        // Search with debounce
        let searchTimeout;
        
        // Setup search input event listeners when DOM is ready
        function setupSearchInput() {
            const searchInput = document.getElementById('searchFoodInput');
            if (searchInput) {
                // Remove existing listeners by cloning
                const newInput = searchInput.cloneNode(true);
                searchInput.parentNode.replaceChild(newInput, searchInput);
                
                newInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    const search = this.value.trim();
                    searchTimeout = setTimeout(() => {
                        loadFoods(search);
                    }, 300);
                });

                // Search on Enter
                newInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        clearTimeout(searchTimeout);
                        loadFoods(this.value.trim());
                    }
                });
            }
        }
        
        // Setup on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupSearchInput);
        } else {
            setupSearchInput();
        }

        function displayFoods(foods) {
            const foodList = document.getElementById('foodList');
            
            if (!foods || foods.length === 0) {
                foodList.innerHTML = '<div class="food-list-empty"><i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem;"></i><p>Không tìm thấy món ăn nào.</p></div>';
                return;
            }
            
            foodList.innerHTML = foods.map(food => {
                const tenMonAn = escapeHtml(food.tenMonAn || 'N/A');
                const monAnId = escapeHtml(food.monAnId || '');
                const donViTinh = escapeHtml(food.donViTinh || 'g');
                const luongCalo = food.luongCalo ? Math.round(food.luongCalo) : 0;
                const protein = food.protein ? Math.round(food.protein * 10) / 10 : 0;
                const carbohydrate = food.carbohydrate ? Math.round(food.carbohydrate * 10) / 10 : 0;
                const chatBeo = food.chatBeo ? Math.round(food.chatBeo * 10) / 10 : 0;
                
                return `
                    <div class="food-list-item" onclick="selectFood('${monAnId}', '${tenMonAn}', '${donViTinh}', ${luongCalo}, ${protein}, ${carbohydrate}, ${chatBeo})">
                        <div style="font-weight: 600; margin-bottom: 0.25rem;">${tenMonAn}</div>
                        <div style="font-size: 0.85rem; opacity: 0.7;">
                            ${luongCalo > 0 ? luongCalo + ' kcal' : ''}
                            ${protein > 0 ? ' • P: ' + protein + 'g' : ''}
                            ${carbohydrate > 0 ? ' • C: ' + carbohydrate + 'g' : ''}
                            ${chatBeo > 0 ? ' • F: ' + chatBeo + 'g' : ''}
                            <span style="opacity: 0.5;"> • ${donViTinh}/100g</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function selectFood(monAnId, tenMonAn, donViTinh, luongCalo, protein, carbohydrate, chatBeo) {
            selectedFood = {
                monAnId: monAnId,
                tenMonAn: tenMonAn,
                donViTinh: donViTinh,
                luongCalo: luongCalo,
                protein: protein,
                carbohydrate: carbohydrate,
                chatBeo: chatBeo
            };
            
            openFoodDetailDialog();
        }

        // Hàm helper để tính toán giá trị dinh dưỡng dựa trên đơn vị
        function calculateNutritionValue(baseValue, quantity, unit) {
            if (!baseValue || !quantity || quantity <= 0) return 0;
            
            const unitLower = (unit || '').toLowerCase().trim();
            // Với đơn vị "cái" hoặc "chén" thì tính trực tiếp (giá trị DB đã là cho 1 cái/chén)
            // Với đơn vị "g" hoặc "ml" thì chia 100 (giá trị DB là cho 100g/ml)
            if (unitLower === 'cái' || unitLower === 'chén') {
                return baseValue * quantity;
            } else {
                // Mặc định chia 100 cho g, ml, và các đơn vị khác
                return baseValue * quantity / 100;
            }
        }

        function updateNutritionPreview() {
            if (!selectedFood) return;
            
            const preview = document.getElementById('foodInfoPreview');
            const luongThucAnInput = document.getElementById('luongThucAn');
            
            const luongThucAn = parseFloat(luongThucAnInput.value) || 0;
            
            if (luongThucAn <= 0) {
                preview.innerHTML = `
                    <div class="food-name">${escapeHtml(selectedFood.tenMonAn)}</div>
                    <div class="food-macros" style="opacity: 0.7;">
                        Vui lòng nhập lượng thực phẩm
                    </div>
                `;
                return;
            }
            
            // Tính toán dựa trên đơn vị
            const calo = calculateNutritionValue(selectedFood.luongCalo, luongThucAn, selectedFood.donViTinh);
            const protein = calculateNutritionValue(selectedFood.protein, luongThucAn, selectedFood.donViTinh);
            const carb = calculateNutritionValue(selectedFood.carbohydrate, luongThucAn, selectedFood.donViTinh);
            const fat = calculateNutritionValue(selectedFood.chatBeo, luongThucAn, selectedFood.donViTinh);
            
            // Xác định text hiển thị cho đơn vị gốc
            const unitLower = (selectedFood.donViTinh || '').toLowerCase().trim();
            const baseUnitText = (unitLower === 'cái' || unitLower === 'chén') 
                ? `(cho 1 ${selectedFood.donViTinh})` 
                : `(cho 100${selectedFood.donViTinh})`;
            
            // Cập nhật preview với giá trị đã tính toán
            preview.innerHTML = `
                <div class="food-name">${escapeHtml(selectedFood.tenMonAn)}</div>
                <div class="food-macros">
                    <div style="margin-bottom: 0.5rem;">
                        <strong>Lượng: ${luongThucAn} ${selectedFood.donViTinh}</strong>
                    </div>
                    <div>
                        ${calo > 0 ? '<span style="color: #4ade80;">' + Math.round(calo) + ' kcal</span>' : ''}
                        ${protein > 0 ? ' • <span style="color: #22d3ee;">P: ' + Math.round(protein * 10) / 10 + 'g</span>' : ''}
                        ${carb > 0 ? ' • <span style="color: #fbbf24;">C: ' + Math.round(carb * 10) / 10 + 'g</span>' : ''}
                        ${fat > 0 ? ' • <span style="color: #fb7185;">F: ' + Math.round(fat * 10) / 10 + 'g</span>' : ''}
                    </div>
                    <div style="opacity: 0.7; font-size: 0.85rem; margin-top: 0.5rem;">
                        Giá trị gốc ${baseUnitText}
                    </div>
                </div>
            `;
        }

        function openFoodDetailDialog() {
            if (!selectedFood) return;
            
            const dialog = document.getElementById('foodDetailDialog');
            const preview = document.getElementById('foodInfoPreview');
            const donViTinhInput = document.getElementById('donViTinh');
            const luongThucAnInput = document.getElementById('luongThucAn');
            
            // Set form values
            donViTinhInput.value = selectedFood.donViTinh;
            
            // Set giá trị mặc định: 100 cho g/ml, 1 cho cái/chén
            const unitLower = (selectedFood.donViTinh || '').toLowerCase().trim();
            const defaultValue = (unitLower === 'cái' || unitLower === 'chén') ? '1' : '100';
            luongThucAnInput.value = defaultValue;
            luongThucAnInput.placeholder = `Nhập số lượng (${selectedFood.donViTinh})`;
            
            // Xóa event listener cũ nếu có
            luongThucAnInput.removeEventListener('input', updateNutritionPreview);
            luongThucAnInput.removeEventListener('change', updateNutritionPreview);
            
            // Thêm event listener để tính toán tự động khi nhập
            luongThucAnInput.addEventListener('input', updateNutritionPreview);
            luongThucAnInput.addEventListener('change', updateNutritionPreview);
            
            // Cập nhật preview lần đầu với giá trị mặc định
            updateNutritionPreview();
            
            dialog.classList.add('show');
            
            // Focus on amount input
            setTimeout(() => {
                luongThucAnInput.focus();
                luongThucAnInput.select();
            }, 100);
        }

        function closeFoodDetailDialog() {
            const dialog = document.getElementById('foodDetailDialog');
            const luongThucAnInput = document.getElementById('luongThucAn');
            
            // Xóa event listener khi đóng dialog
            if (luongThucAnInput) {
                luongThucAnInput.removeEventListener('input', updateNutritionPreview);
                luongThucAnInput.removeEventListener('change', updateNutritionPreview);
            }
            
            dialog.classList.remove('show');
            selectedFood = null;
            document.getElementById('foodDetailForm').reset();
        }

        function submitFoodDetail(event) {
            event.preventDefault();
            
            if (!selectedFood) return;
            
            const luongThucAn = parseFloat(document.getElementById('luongThucAn').value);
            const ghiChu = document.getElementById('ghiChu').value;
            
            if (!luongThucAn || luongThucAn <= 0) {
                alert('Vui lòng nhập lượng thực phẩm hợp lệ');
                return;
            }
            
            addMeal(selectedFood.monAnId, luongThucAn, ghiChu);
        }

        async function addMeal(monAnId, luongThucAn, ghiChu) {
            try {
                const date = document.getElementById('selectedDate').value;
                const response = await fetch('/DinhDuong/AddToNhatKy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        monAnId: monAnId,
                        luongThucAn: luongThucAn,
                        ghiChu: ghiChu,
                        ngayGhiLog: date
                    })
                });
                
                // Kiểm tra response có phải JSON không
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text);
                    showNotification('Lỗi server: ' + (text.substring(0, 100) || 'Không thể xử lý phản hồi'), 'error');
                    return;
                }
                
                const result = await response.json();
                if (result.success) {
                    closeFoodDetailDialog();
                    closeAddMealModal();
                    
                    // Show success notification
                    showNotification('Đã thêm món ăn vào nhật ký!', 'success');
                    
                    // Cập nhật UI động thay vì reload trang
                    await updateNutritionUI();
                } else {
                    showNotification(result.message || 'Có lỗi xảy ra', 'error');
                }
            } catch (error) {
                console.error('Error adding meal:', error);
                showNotification('Có lỗi xảy ra khi thêm món ăn: ' + error.message, 'error');
            }
        }

        // Cập nhật UI động sau khi thêm/xóa món ăn
        async function updateNutritionUI() {
            try {
                const date = document.getElementById('selectedDate').value;
                const response = await fetch(`/DinhDuong/GetNutritionData?selectedDate=${encodeURIComponent(date)}`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch nutrition data');
                }
                
                const result = await response.json();
                if (result.success && result.data) {
                    const { meals, summary } = result.data;
                    
                    // Cập nhật summary cards
                    document.getElementById('totalCalo').textContent = summary.tongCalo;
                    document.getElementById('totalProtein').textContent = summary.tongProtein;
                    document.getElementById('totalCarbs').textContent = summary.tongCarbs;
                    document.getElementById('totalFat').textContent = summary.tongChatBeo;
                    
                    // Cập nhật meal list
                    const mealList = document.getElementById('mealList');
                    if (meals && meals.length > 0) {
                        mealList.innerHTML = meals.map(meal => {
                            const luong = meal.luongThucAn ?? 0;
                            const donViTinh = (meal.donViTinh || '').toLowerCase().trim();
                            const isPieceOrBowl = donViTinh === 'cái' || donViTinh === 'chén';
                            const calo = isPieceOrBowl 
                                ? Math.round(meal.luongCalo * luong) 
                                : Math.round(meal.luongCalo * luong / 100);
                            const protein = isPieceOrBowl 
                                ? Math.round(meal.protein * luong * 10) / 10 
                                : Math.round(meal.protein * luong / 100 * 10) / 10;
                            const carbs = isPieceOrBowl 
                                ? Math.round(meal.carbohydrate * luong * 10) / 10 
                                : Math.round(meal.carbohydrate * luong / 100 * 10) / 10;
                            const fat = isPieceOrBowl 
                                ? Math.round(meal.chatBeo * luong * 10) / 10 
                                : Math.round(meal.chatBeo * luong / 100 * 10) / 10;
                            
                            return `
                                <div class="meal-item" data-id="${escapeHtml(meal.dinhDuongId)}">
                                    <div class="meal-info">
                                        <div class="meal-name">${escapeHtml(meal.tenMonAn || 'N/A')}</div>
                                        <div class="meal-details">
                                            <span>${luong} ${escapeHtml(meal.donViTinh || 'g')}</span>
                                            <span>•</span>
                                            <span>${calo} kcal</span>
                                            <span>•</span>
                                            <span>P: ${protein}g</span>
                                            <span>•</span>
                                            <span>C: ${carbs}g</span>
                                            <span>•</span>
                                            <span>F: ${fat}g</span>
                                        </div>
                                        ${meal.ghiChu ? `
                                            <div style="font-size: 0.85rem; opacity: 0.7; margin-top: 0.25rem;">
                                                <i class="fas fa-tag"></i> ${escapeHtml(meal.ghiChu)}
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div class="meal-actions">
                                        <button onclick="removeMeal('${escapeHtml(meal.dinhDuongId)}')" title="Xóa">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        mealList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-utensils"></i>
                                <p>Chưa có món ăn nào được thêm vào hôm nay</p>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error updating nutrition UI:', error);
                // Fallback: reload trang sau 2 giây để thông báo có thời gian hiển thị
                setTimeout(() => {
                    loadNutritionData();
                }, 2000);
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                color: white;
                font-weight: 500;
                z-index: 10002;
                animation: slideInRight 0.3s ease;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                display: flex;
                align-items: center;
                gap: 0.75rem;
            `;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                <span>${escapeHtml(message)}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @@keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @@keyframes slideOutRight {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        async function addMealFromPopular(monAnId, tenMonAn) {
            // Tìm món ăn từ danh sách đã load hoặc load từ server
            const food = allFoods.find(f => f.monAnId === monAnId);
            
            if (food) {
                selectFood(
                    food.monAnId,
                    food.tenMonAn || tenMonAn,
                    food.donViTinh || 'g',
                    food.luongCalo || 0,
                    food.protein || 0,
                    food.carbohydrate || 0,
                    food.chatBeo || 0
                );
            } else {
                // Nếu chưa có trong danh sách, load từ server
                try {
                    const response = await fetch(`/DinhDuong/GetMonAn?search=${encodeURIComponent(tenMonAn)}`);
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        const foundFood = result.data.find(f => f.monAnId === monAnId);
                        if (foundFood) {
                            selectFood(
                                foundFood.monAnId,
                                foundFood.tenMonAn || tenMonAn,
                                foundFood.donViTinh || 'g',
                                foundFood.luongCalo || 0,
                                foundFood.protein || 0,
                                foundFood.carbohydrate || 0,
                                foundFood.chatBeo || 0
                            );
                        } else {
                            // Fallback với thông tin tối thiểu
                            selectFood(monAnId, tenMonAn, 'g', 0, 0, 0, 0);
                        }
                    } else {
                        selectFood(monAnId, tenMonAn, 'g', 0, 0, 0, 0);
                    }
                } catch (error) {
                    console.error('Error loading food details:', error);
                    selectFood(monAnId, tenMonAn, 'g', 0, 0, 0, 0);
                }
            }
        }

        let pendingDeleteMealId = null;

        function removeMeal(dinhDuongId) {
            pendingDeleteMealId = dinhDuongId;
            openDeleteConfirmDialog();
        }

        function openDeleteConfirmDialog() {
            const dialog = document.getElementById('deleteConfirmDialog');
            dialog.classList.add('show');
        }

        function closeDeleteConfirmDialog() {
            const dialog = document.getElementById('deleteConfirmDialog');
            dialog.classList.remove('show');
            pendingDeleteMealId = null;
        }

        async function confirmDeleteMeal() {
            if (!pendingDeleteMealId) return;
            
            const dinhDuongId = pendingDeleteMealId;
            closeDeleteConfirmDialog();
            
            try {
                const response = await fetch('/DinhDuong/RemoveFromNhatKy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        dinhDuongId: dinhDuongId
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showNotification('Đã xóa món ăn khỏi nhật ký!', 'success');
                    // Cập nhật UI động
                    await updateNutritionUI();
                } else {
                    showNotification(result.message || 'Có lỗi xảy ra', 'error');
                }
            } catch (error) {
                console.error('Error removing meal:', error);
                showNotification('Có lỗi xảy ra khi xóa món ăn', 'error');
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const addMealModal = document.getElementById('addMealModal');
            const foodDetailDialog = document.getElementById('foodDetailDialog');
            const deleteConfirmDialog = document.getElementById('deleteConfirmDialog');
            
            if (event.target == addMealModal) {
                closeAddMealModal();
            }
            
            if (event.target == foodDetailDialog) {
                closeFoodDetailDialog();
            }
            
            if (event.target == deleteConfirmDialog) {
                closeDeleteConfirmDialog();
            }
        }

        // Close modals with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const addMealModal = document.getElementById('addMealModal');
                const foodDetailDialog = document.getElementById('foodDetailDialog');
                const deleteConfirmDialog = document.getElementById('deleteConfirmDialog');
                
                if (addMealModal.classList.contains('show')) {
                    closeAddMealModal();
                }
                
                if (foodDetailDialog.classList.contains('show')) {
                    closeFoodDetailDialog();
                }
                
                if (deleteConfirmDialog.classList.contains('show')) {
                    closeDeleteConfirmDialog();
                }
            }
        });

        // Kiểm tra đăng nhập khi trang load
        @if (ViewData["RequireLogin"] != null && (bool)ViewData["RequireLogin"])
        {
            var loginMsg = ViewData["LoginMessage"]?.ToString() ?? "Vui lòng đăng nhập để sử dụng tính năng này.";
            var escapedMsg = loginMsg.Replace("'", "\\'").Replace("\"", "\\\"").Replace("\r", "").Replace("\n", "\\n");
            <text>
            showLoginRequiredNotification('@Html.Raw(escapedMsg)');
            </text>
        }
        else
        {
            <text>
            // Kiểm tra authentication từ server
            (async function() {
                try {
                    const response = await fetch('/Account/IsAuthenticated', { credentials: 'same-origin' });
                    const result = await response.json();
                    if (!result.isAuthenticated) {
                        showLoginRequiredNotification('Vui lòng đăng nhập để sử dụng tính năng này.');
                    }
                } catch (error) {
                    console.error('Error checking authentication:', error);
                }
            })();
            </text>
        }

        function showLoginRequiredNotification(message) {
            // Tạo overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px);';
            
            // Tạo dialog
            const dialog = document.createElement('div');
            dialog.style.cssText = 'background: rgba(30, 41, 59, 0.98); padding: 2rem; border-radius: 20px; max-width: 500px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); animation: slideUp 0.3s ease;';
            
            dialog.innerHTML = `
                <div style="font-size: 3rem; color: #ef4444; margin-bottom: 1rem;">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem; color: #fff;">Yêu cầu đăng nhập</h2>
                <p id="loginMessage" style="font-size: 1rem; opacity: 0.8; margin-bottom: 2rem; color: #fff;"></p>
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <a href="/Account/Login" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #4ade80, #22d3ee); color: #fff; border-radius: 12px; text-decoration: none; font-weight: 600; transition: all 0.3s ease;">
                        <i class="fas fa-sign-in-alt"></i> Đăng nhập
                    </a>
                    <a href="/" style="padding: 0.75rem 1.5rem; background: rgba(255, 255, 255, 0.1); color: #fff; border-radius: 12px; text-decoration: none; font-weight: 600; transition: all 0.3s ease;">
                        <i class="fas fa-home"></i> Về trang chủ
                    </a>
                </div>
            `;
            
            // Sử dụng textContent để hiển thị message an toàn mà không escape tiếng Việt
            const messageElement = dialog.querySelector('#loginMessage');
            if (messageElement) {
                messageElement.textContent = message;
            }
            
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            
            // Thêm animation
            if (!document.getElementById('loginRequiredAnimation')) {
                const style = document.createElement('style');
                style.id = 'loginRequiredAnimation';
                style.textContent = `
                    @@keyframes slideUp {
                        from {
                            transform: translateY(50px);
                            opacity: 0;
                        }
                        to {
                            transform: translateY(0);
                            opacity: 1;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Đóng khi click vào overlay
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    window.location.href = '/';
                }
            });
        }
    </script>
}

